#
# Sample nginx RTMP configuration for live video streaming
# 
# This configuration sets up nginx with the RTMP module to receive and
# distribute live video streams. It's designed for use with the Soccer AI
# stream processor on Jetson Orin Nano devices.
#

# RTMP configuration
rtmp {
    server {
        # Listen on default RTMP port
        listen 1935;
        
        # Maximum chunk size for RTMP packets
        chunk_size 4096;
        
        # Input application - receives streams from encoders/cameras
        application live {
            # Enable live streaming
            live on;
            
            # Disable recording by default (enable if you want to save streams)
            record off;
            
            # Allow publishing from localhost only (security)
            # Comment out to allow publishing from any IP
            allow publish 127.0.0.1;
            deny publish all;
            
            # Allow playback from any IP
            allow play all;
            
            # Buffer length in milliseconds
            # Increase for smoother playback, decrease for lower latency
            buflen 1000ms;
            
            # Enable pushing to other applications
            # Uncomment to forward streams
            # push rtmp://localhost/processed;
        }
        
        # Processed application - receives streams from the AI processor
        application processed {
            # Enable live streaming
            live on;
            
            # Disable recording by default
            record off;
            
            # Allow publishing from localhost only
            allow publish 127.0.0.1;
            deny publish all;
            
            # Allow playback from any IP
            allow play all;
            
            # Buffer length
            buflen 1000ms;
        }
        
        # Recording application - saves streams to disk (optional)
        application recorded {
            live on;
            
            # Enable recording
            record all;
            record_path /tmp/recordings;
            record_unique on;
            
            # Allow publishing from localhost only
            allow publish 127.0.0.1;
            deny publish all;
            
            # Allow playback from any IP
            allow play all;
        }
    }
}

# HTTP configuration for HLS streaming and statistics
http {
    server {
        # Listen on port 8080
        listen 8080;
        
        # Server name
        server_name localhost;
        
        # HLS streaming location
        location /hls {
            # CORS headers for cross-origin playback
            add_header 'Access-Control-Allow-Origin' '*' always;
            add_header 'Access-Control-Expose-Headers' 'Content-Length';
            
            # Disable cache
            add_header 'Cache-Control' 'no-cache';
            
            # HLS specific MIME types
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
            
            # Path to HLS files
            root /tmp;
            
            # Allow from any origin
            add_header 'Access-Control-Allow-Origin' '*' always;
        }
        
        # RTMP statistics
        location /stat {
            rtmp_stat all;
            rtmp_stat_stylesheet stat.xsl;
        }
        
        # RTMP stat stylesheet
        location /stat.xsl {
            root /usr/local/nginx/html;
        }
        
        # Control interface for managing streams
        location /control {
            rtmp_control all;
        }
    }
}

#
# Installation and Usage:
#
# 1. Install nginx with RTMP module:
#    sudo apt-get install libnginx-mod-rtmp
#
# 2. Copy this file to nginx configuration directory:
#    sudo cp nginx-rtmp.conf /etc/nginx/nginx.conf
#
# 3. Create required directories:
#    sudo mkdir -p /tmp/recordings
#    sudo chmod 777 /tmp/recordings
#
# 4. Restart nginx:
#    sudo systemctl restart nginx
#
# 5. Test the setup:
#    - Push a test stream: ffmpeg -re -i test.mp4 -c copy -f flv rtmp://localhost/live/test
#    - Play the stream: ffplay rtmp://localhost/live/test
#    - View statistics: http://localhost:8080/stat
#
# 6. Use with Soccer AI:
#    python main.py --stream_mode \
#                   --input_rtmp_url rtmp://localhost/live/camera1 \
#                   --output_rtmp_url rtmp://localhost/processed/output \
#                   --device cuda --mode PLAYER_TRACKING
#
